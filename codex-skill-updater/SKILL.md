---
name: codex-skill-updater
description: Update installed user Codex skills safely with prechecks, strategy-based execution, backups, rollback, and source-map support for private/custom skills.
---

# Skill Updater

Use this skill when you want to keep installed user skills up to date in `~/.codex/skills` and handle mixed sources (GitHub, source-map, local archive, private repos).

## Prerequisites

- Required: `python3`, `git`
- Optional: `gh` (not required)
- For private GitHub repos: SSH auth must be configured in this environment (`ssh -T git@github.com`)

## Quick Start

1. Move to this skill directory.
- `cd ~/.codex/skills/codex-skill-updater`

2. Dry-run (no artifact files generated by default).
- `cp config/skills_source_map.local.example.json config/skills_source_map.local.json` (first time only)
- `python3 scripts/update_skills.py --dry-run --allow-manual-map --source-map ./config/skills_source_map.json --source-map-local ./config/skills_source_map.local.json --jobs 4`

3. Apply updates.
- `python3 scripts/update_skills.py --allow-manual-map --source-map ./config/skills_source_map.json --source-map-local ./config/skills_source_map.local.json --jobs 4`

4. Debug mode only (fixed file names in current directory).
- `python3 scripts/update_skills.py --dry-run --allow-manual-map --source-map ./config/skills_source_map.json --source-map-local ./config/skills_source_map.local.json --debug-artifacts`
- outputs: `skill_update_check.debug.ndjson`, `skill_update_apply_report.debug.json`

## Strategy Model

`check_skill_updates.py` classifies each skill into one strategy:

- `update-via-github`
  - Update from detected `repo/path` using `install-skill-from-github.py`
- `install-from-local-archive`
  - Install from local `.skill` archive (usually `~/.codex/skills/dist/<name>.skill`)
- `manual-source-map-required`
  - Source cannot be inferred; you must define it in source map

`~/.codex/skills/.system` はこのワークフローの更新対象外です。

## Handling Newly Added Skills

When new skills are added later and show up as `manual-source-map-required`:

1. Public repo entries go to `config/skills_source_map.json`.
2. Private repo entries go to `config/skills_source_map.local.json` (untracked).
3. If both files contain the same skill key, `skills_source_map.local.json` overrides `skills_source_map.json`.
4. Re-run dry-run with manual map enabled.
5. Apply once dry-run is clean.

Use this format:

```json
{
  "skill-name": {
    "repo": "owner/repo",
    "path": "skills/skill-name",
    "ref": "main"
  }
}
```

- `path` may be `.` when the skill is at repo root.
- You can override source map path via `--source-map /path/to/skills_source_map.json`.
- You can set local private map path via `--source-map-local /path/to/skills_source_map.local.json`.

## Safety Rules

- Default behavior creates backups under `$CODEX_HOME/backups/<timestamp>/`.
- Backup generations are retained per run (latest 2 generations) and pruned only when an update run completes without failures.
- On failure, rollback is attempted automatically.
- If staged content is identical to installed content, update is skipped (`no_changes_detected`).
- `--jobs` controls parallelism for precheck/probing and staging (recommended: `3-4`, max `8`).
- Safety model: staging runs in parallel, but final apply+rollback runs serially.
- Use `--fail-fast` to stop on first failure.
- Use `--strategy` and `--skill` to run partial updates safely.
- `--backup-root` custom path is not supported.

## Notes

- This workflow updates user skills in `~/.codex/skills` (except `.system`).
- Restart Codex after updates to ensure new skill contents are picked up.
- `apply_skill_updates.py` can read check input (`ndjson` or `tsv`) from stdin with `--check-file -` and `--check-format`.
